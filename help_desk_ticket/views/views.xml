<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Extended view = helpdesk team form (HELPDESK Team creation form) -->
        <record id="helpdesk_team_ext" model="ir.ui.view">
            <field name="name">helpdesk_team_ext</field>
            <field name="model">helpdesk.team</field>
            <field name="inherit_id" ref="helpdesk.helpdesk_team_view_form" />
            <field name="arch" type="xml">
                <xpath expr="//sheet//div//div[3]//div[2]//field[@name='visibility_member_ids']" position="after">
                    <div>.</div>
                    <div>.</div>
                    <div>
                        <group string=' '>
                            <!-- <label for="ticket_type">Ticket type: </label> -->
                            <field name="team_name" readonly="1"/>
                            <field name="default_team"/>
                            <field name="ticket_type" widget="many2many_tags" />
                        </group>
                    </div>
                    <div>.</div>
                    <div>
                        <label for="ticket_tag">Ticket tag: </label>
                        <field name="ticket_tag" widget="many2many_tags" />
                    </div>
                </xpath>
            </field>
        </record>
        
        <!-- Extended view = All tickets (create ticket forms) -->
        <record id="helpdesk_type_ext" model="ir.ui.view">
            <field name="name">helpdesk_type_ext</field>
            <field name="model">helpdesk.ticket</field>
            <field name="inherit_id" ref="helpdesk.helpdesk_ticket_view_form" />
            <field name="arch" type="xml">
                <xpath expr="//field[@name='ticket_type_id']" position="replace">
                    <field name="ticket_type_id" domain="[('id', 'in', ticket_type)]" />
                    <field name="ticket_type" widget="many2many_tags" nolabel="1" invisible="1" />
                </xpath>
                <xpath expr="//field[@name='tag_ids']" position="replace">
                    <field name="tag_ids" domain="[('id', 'in',ticket_tag)]" widget="many2many_tags" options="{'color_field': 'color','no_create': True ,'no_open': True}" />
                    <field name="ticket_tag" widget="many2many_tags" nolabel="1" invisible="1" />
                </xpath>

                <xpath expr="//field[@name='team_id']" position="attributes">
                     <attribute name ="readonly">1</attribute>       
                </xpath>


                <xpath expr="//field[@name='team_id']" position="attributes">
                     <attribute name="options">{'no_open':True}</attribute> 
                </xpath>

                <xpath expr="//field[@name='user_id']" position="attributes">
                     <attribute name ="readonly">1</attribute>       
                </xpath>

                <xpath expr="//field[@name='partner_id']" position="attributes">
                     <attribute name ="readonly">1</attribute>       
                </xpath>


                <xpath expr="//field[@name='partner_id']" position="attributes">
                     <attribute name="options">{'no_open':True}</attribute> 
                </xpath>

                <xpath expr="//field[@name='partner_email']" position="attributes">
                     <attribute name ="readonly">1</attribute>       
                </xpath>


            </field>
        </record>

        <record id="help_desk_extention_readonly_0" model="ir.ui.view">
            <field name="name">help_desk_extention_readonly_0</field>
            <field name="model">helpdesk.ticket</field>
            <field name="inherit_id" ref="helpdesk_type_ext" />
            <field name="groups_id" eval="[(6, 0, [ref('helpdesk.group_helpdesk_manager')])]" />                
            <field name="arch" type="xml">                                   
                <field name="team_id" position="attributes">
                   <attribute name="readonly">0</attribute>                   
                </field>                                    
                <field name="user_id" position="attributes">
                   <attribute name="readonly">0</attribute>                   
                </field>                                                   
            </field>
        </record>  


        <!-- Extended view = All tickets (create ticket forms) -->
        <record id="helpdesk_stage_ext" model="ir.ui.view">
            <field name="name">helpdesk_stage_ext</field>
            <field name="model">helpdesk.stage</field>
            <field name="inherit_id" ref="helpdesk.helpdesk_stage_view_form" />
            <field name="arch" type="xml">
                
                <xpath expr="//field[@name='is_close']" position="after">
                    <field name="re_open_stage"/>
                </xpath>

            </field>
        </record>

    <record id="rating_ticket_request_email_template" model="mail.template">
        <field name="name">Ticket: Rating Request (requires rating enabled on team)</field>
        <field name="model_id" ref="helpdesk.model_helpdesk_ticket"/>
        <field name="subject">${object.company_id.name or object.user_id.company_id.name or 'Helpdesk'}: Service Rating Request</field>
        <field name="email_from">${object.rating_get_rated_partner_id().email_formatted | safe}</field>
        <field name="email_to">${(object.partner_email if not object.sudo().partner_id.email or object.sudo().partner_id.email != object.partner_email else '') | safe}</field>
        <field name="partner_to">${object.partner_id.id if object.sudo().partner_id.email and object.sudo().partner_id.email == object.partner_email else ''}</field>
        <field name="body_html" type="xml">
<div>
    % set access_token = object.rating_get_access_token()
    % set partner = object.rating_get_partner_id()
    <table border="0" cellpadding="0" cellspacing="0" style="width:100%; margin:0;">
    <tbody>
        <tr><td valign="top" style="font-size: 14px;">
            % if partner.name:
                Hello ${partner.name},<br/>
            % else:
                Hello,<br/>
            % endif
            Please take a moment to rate our services related to the ticket "<strong>${object.name}</strong>"
            % if object.rating_get_rated_partner_id().name:
                assigned to <strong>${object.rating_get_rated_partner_id().name}</strong>.<br/>
            % else:
                .<br/>
            % endif
        </td></tr>
        <tr><td style="text-align: center;">
            <table border="0" cellpadding="0" cellspacing="0" summary="o_mail_notification" style="width:100%; margin: 32px 0px 32px 0px;">
                <tr><td style="font-size: 14px;">
                    <strong>Tell us how you feel about our service</strong><br/>
                    <span style="text-color: #888888">(click on one of these smileys)</span>
                </td></tr>
                <tr><td style="font-size: 14px;">
                    <table style="width:100%;text-align:center;">
                        <tr>
                            <td>
                                <a href="/rate/${access_token}/5">
                                    <img alt="Satisfied" src="/rating/static/src/img/rating_5.png" title="Satisfied"/>
                                </a>
                            </td>
                            <td>
                                <a href="/rate/${access_token}/3">
                                    <img alt="Not satisfied" src="/rating/static/src/img/rating_3.png" title="Not satisfied"/>
                                </a>
                            </td>
                            <td>
                                <a href="/rate/${access_token}/1">
                                    <img alt="Highly Dissatisfied" src="/rating/static/src/img/rating_1.png" title="Highly Dissatisfied"/>
                                </a>
                            </td>
                        </tr>
                    </table>
                </td></tr>
            </table>
        </td></tr>
        <tr><td valign="top" style="font-size: 14px;">
            We appreciate your feedback. It helps us to improve continuously.
            <br/><span style="margin: 0px 0px 0px 0px; font-size: 12px; opacity: 0.5; color: #454748;">This customer survey has been sent because your ticket has been moved to the stage <b>${object.stage_id.name}</b></span>
        </td></tr>
    </tbody>
    </table>
</div>
        </field>
        <field name="lang">${object.partner_id.lang or object.user_id.lang or user.lang}</field>
        <field name="auto_delete" eval="True"/>
    </record>
    </data>

        <template id="rating_external_page_submit_re_open" name="Rating Page Submit">
            <t t-call="web.frontend_layout">
                <div class="container card mb-5 mt-4 o_rating_page_submit">
                    <div class="card-body">
                        <div class="row text-center justify-content-center">
                            <h1 class="col-12 mt-5">Are you sure you want to re open the ticket!</h1>
                            <form t-attf-action="/rate/#{token}/submit_feedback" method="post">
                                <div class="btn-group btn-group-toggle row" data-toggle="buttons">
                                    <t t-foreach="rate_names" t-as="rate_name">
                                        <label t-attf-class="col-xs-12 btn o_rating_label shadow-none {{rate == rate_name and 'active' or ''}}">
                                            <input type="radio" name="rate" t-attf-id="rate_{{rate_name}}" t-att-value="rate_name" t-att-checked="rate == rate_name"/>
                                            <!-- <a class="o_rating" href="#">
                                                <img t-attf-src='/rating/static/src/img/rating_#{rate_name}.png' t-att-alt="rate_name_value" t-att-title="rate_name_value"/>
                                            </a> -->
                                        </label>
                                    </t>
                                </div>
                                <div class="clearfix"></div>
                                <p class="mt-5">
                                    Comment Box:
                                </p>
                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                <textarea class="form-control" name="feedback" rows="2" t-att-value="rating.feedback" required="1"></textarea>
                                <button type="submit" class="btn btn-primary" style="margin-top:8px;">Re Open</button>
                            </form>
                        </div>
                    </div>
                </div>
            </t>
        </template>
</odoo>